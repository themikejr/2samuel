---
import { getCollection } from 'astro:content';
import Layout from '../../layouts/Layout.astro';

export async function getStaticPaths() {
	const characters = await getCollection('characters');
	return characters.map((character) => ({
		params: { slug: character.id },
		props: { character },
	}));
}

const { character } = Astro.props;
const allCharacters = await getCollection('characters');

// Helper function to get character by ACAI ID
function getCharacterByAcaiId(acaiId: string) {
	return allCharacters.find((c) => c.data.acaiId === acaiId);
}

// Helper function to format reference
function formatReference(ref: string): { chapter: number; verse: number } {
	// Reference format: BBCCCVVV where BB=book, CCC=chapter, VVV=verse
	const chapter = parseInt(ref.substring(2, 5), 10);
	const verse = parseInt(ref.substring(5, 8), 10);
	return { chapter, verse };
}

// Helper function to extract base name (before first parenthesis)
function getBaseName(name: string): string {
	return name.split('(')[0].trim();
}

// Helper function to link character names in text using relationship context
function linkCharacterNames(text: string, relationshipContext: Map<string, any>): string {
	let linkedText = text;

	// Build a map of base names to character data from relationship context
	// This allows us to link "Ahinoam" to the specific "Ahinoam (Wife of David)"
	const nameToCharMap = new Map<string, { id: string; fullName: string; baseName: string }>();

	for (const [acaiId, char] of relationshipContext) {
		const baseName = getBaseName(char.data.name);
		const lowerBaseName = baseName.toLowerCase();

		// Check for base name conflicts in relationship context
		if (nameToCharMap.has(lowerBaseName)) {
			// If multiple people with same base name in relationships, use full name
			const existing = nameToCharMap.get(lowerBaseName)!;
			// Mark both as needing full name matching
			existing.baseName = existing.fullName;
			nameToCharMap.set(lowerBaseName, {
				id: char.id,
				fullName: char.data.name,
				baseName: char.data.name // Use full name to avoid ambiguity
			});
		} else {
			nameToCharMap.set(lowerBaseName, {
				id: char.id,
				fullName: char.data.name,
				baseName: baseName
			});
		}
	}

	// Sort by name length (longest first) to avoid partial matches
	const sortedEntries = Array.from(nameToCharMap.entries()).sort(
		(a, b) => b[1].baseName.length - a[1].baseName.length
	);

	// Link characters from relationship context
	for (const [lowerName, charInfo] of sortedEntries) {
		// Try to match the base name in text
		const namePattern = charInfo.baseName.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
		const regex = new RegExp(`\\b${namePattern}('s)?\\b`, 'gi');

		linkedText = linkedText.replace(regex, (match) => {
			return `<a href="/characters/${charInfo.id}/" class="character-link">${match}</a>`;
		});
	}

	return linkedText;
}

// Separate 2 Samuel references from all Bible references
const samuelReferences = character.data.references.filter(ref => ref.startsWith('10'));
const allReferences = character.data.references;

// Group 2 Samuel references by chapter
const referencesByChapter = samuelReferences.reduce((acc, ref) => {
	const { chapter, verse } = formatReference(ref);
	if (!acc[chapter]) {
		acc[chapter] = [];
	}
	acc[chapter].push(verse);
	return acc;
}, {} as Record<number, number[]>);

// Group all references by book
const referencesByBook = allReferences.reduce((acc, ref) => {
	const bookCode = parseInt(ref.substring(0, 2), 10);
	if (!acc[bookCode]) {
		acc[bookCode] = 0;
	}
	acc[bookCode]++;
	return acc;
}, {} as Record<number, number>);

// Get related characters
const father = character.data.father ? getCharacterByAcaiId(character.data.father) : null;
const mother = character.data.mother ? getCharacterByAcaiId(character.data.mother) : null;
const partners = character.data.partners
	? character.data.partners.map((p) => getCharacterByAcaiId(p)).filter(Boolean)
	: [];
const offspring = character.data.offspring
	? character.data.offspring.map((o) => getCharacterByAcaiId(o)).filter(Boolean)
	: [];

// Find siblings (characters who share the same father or mother)
const siblings = allCharacters.filter((c) => {
	// Don't include self
	if (c.data.acaiId === character.data.acaiId) return false;

	// Check if they share a parent
	const sharesFather = character.data.father && c.data.father === character.data.father;
	const sharesMother = character.data.mother && c.data.mother === character.data.mother;

	return sharesFather || sharesMother;
});

// Build relationship context for linking
// Map of ACAI ID -> character object for all related characters
const relationshipContext = new Map<string, any>();

// Add direct relationships
if (father) relationshipContext.set(father.data.acaiId, father);
if (mother) relationshipContext.set(mother.data.acaiId, mother);
partners.forEach((p) => relationshipContext.set(p.data.acaiId, p));
offspring.forEach((o) => relationshipContext.set(o.data.acaiId, o));
siblings.forEach((s) => relationshipContext.set(s.data.acaiId, s));

// Process description to link character names using relationship context
const linkedDescription = linkCharacterNames(character.data.description, relationshipContext);
---

<Layout title={character.data.name}>
	<meta slot="head" name="book-references" content={JSON.stringify(referencesByBook)} />
	<article class="character-detail">
		<div class="character-header">
			{/* Metadata badges */}
			{(character.data.gender || character.data.tribe) && (
				<div class="metadata-badges">
					{character.data.gender && (
						<span class="metadata-badge">
							<span class="metadata-label">Gender</span>
							<span class="metadata-value">{character.data.gender}</span>
						</span>
					)}
					{character.data.tribe && (
						<span class="metadata-badge">
							<span class="metadata-label">Tribe</span>
							<span class="metadata-value">{character.data.tribe.replace('group:', '')}</span>
						</span>
					)}
				</div>
			)}

			{/* Role badges */}
			{character.data.roles && character.data.roles.length > 0 && (
				<div class="roles">
					{character.data.roles.map((role) => (
						<span class="role-badge">{role}</span>
					))}
				</div>
			)}

			<p class="description" set:html={linkedDescription}></p>
		</div>

		{(father || mother || siblings.length > 0 || partners.length > 0 || offspring.length > 0) && (
			<section class="family-section">
				<h2>Family Relationships</h2>

				<div class="family-tree">
					{/* Parents */}
					{(father || mother) && (
						<div class="family-group">
							<h3 class="family-label">Parents</h3>
							<div class="family-members">
								{father && (
									<a href={`/characters/${father.id}/`} class="family-member">
										<span class="relation-icon">üë®</span>
										<span class="member-name">{father.data.name}</span>
										<span class="member-role">Father</span>
									</a>
								)}
								{mother && (
									<a href={`/characters/${mother.id}/`} class="family-member">
										<span class="relation-icon">üë©</span>
										<span class="member-name">{mother.data.name}</span>
										<span class="member-role">Mother</span>
									</a>
								)}
							</div>
						</div>
					)}

					{/* Siblings */}
					{siblings.length > 0 && (
						<div class="family-group">
							<h3 class="family-label">
								{siblings.length === 1 ? 'Sibling' : `Siblings (${siblings.length})`}
							</h3>
							<div class="family-members">
								{siblings.map((sibling) => (
									<a href={`/characters/${sibling.id}/`} class="family-member">
										<span class="relation-icon">ü§ù</span>
										<span class="member-name">{sibling.data.name}</span>
									</a>
								))}
							</div>
						</div>
					)}

					{/* Partners */}
					{partners.length > 0 && (
						<div class="family-group">
							<h3 class="family-label">
								{partners.length === 1 ? 'Spouse' : `Spouses (${partners.length})`}
							</h3>
							<div class="family-members">
								{partners.map((partner) => (
									<a href={`/characters/${partner.id}/`} class="family-member">
										<span class="relation-icon">üíë</span>
										<span class="member-name">{partner.data.name}</span>
									</a>
								))}
							</div>
						</div>
					)}

					{/* Offspring */}
					{offspring.length > 0 && (
						<div class="family-group">
							<h3 class="family-label">
								{offspring.length === 1 ? 'Child' : `Children (${offspring.length})`}
							</h3>
							<div class="family-members">
								{offspring.map((child) => (
									<a href={`/characters/${child.id}/`} class="family-member">
										<span class="relation-icon">üë∂</span>
										<span class="member-name">{child.data.name}</span>
									</a>
								))}
							</div>
						</div>
					)}
				</div>
			</section>
		)}

		<section class="references-section">
			<h2>Scripture References</h2>
			<p class="references-intro">
				{character.data.name} appears in <strong>{allReferences.length} verse{allReferences.length !== 1 ? 's' : ''}</strong> across the Bible{samuelReferences.length > 0 && `, including ${samuelReferences.length} verse${samuelReferences.length !== 1 ? 's' : ''} in 2 Samuel`}.
			</p>

			{/* Bible-wide histogram */}
			{allReferences.length > 0 && (
				<div class="histogram-container">
					<h3 class="histogram-title">References Across the Bible</h3>
					<div class="histogram-wrapper">
						<canvas id="bible-histogram"></canvas>
					</div>
				</div>
			)}

			{/* 2 Samuel histogram */}
			{samuelReferences.length > 0 && (
				<div class="histogram-container">
					<h3 class="histogram-title">References in 2 Samuel</h3>
					<div class="histogram-wrapper">
						<canvas id="samuel-histogram"></canvas>
					</div>
				</div>
			)}

			<div class="references-grid">
				{Object.entries(referencesByChapter)
					.sort(([a], [b]) => parseInt(a) - parseInt(b))
					.map(([chapter, verses]) => (
						<div class="chapter-references">
							<h3 class="chapter-title">
								<a href={`/blog/2samuel-${chapter}/`}>Chapter {chapter}</a>
							</h3>
							<div class="verses">
								{verses
									.sort((a, b) => a - b)
									.map((verse) => (
										<span class="verse-badge">{verse}</span>
									))}
							</div>
						</div>
					))}
			</div>
		</section>

		<div class="data-attribution">
			<p>
				Character data provided by
				<a href="https://github.com/BibleAquifer/ACAI" target="_blank" rel="noopener">ACAI Biblical Entity Data</a>,
				licensed under
				<a href="https://creativecommons.org/licenses/by-sa/4.0/" target="_blank" rel="noopener">CC BY-SA 4.0</a>.
			</p>
		</div>
	</article>
</Layout>

<script>
	import { Chart, registerables } from 'chart.js';
	Chart.register(...registerables);

	// Book code to name mapping
	const bookNames: Record<number, string> = {
		1: 'Genesis', 2: 'Exodus', 3: 'Leviticus', 4: 'Numbers', 5: 'Deuteronomy',
		6: 'Joshua', 7: 'Judges', 8: 'Ruth', 9: '1 Samuel', 10: '2 Samuel',
		11: '1 Kings', 12: '2 Kings', 13: '1 Chronicles', 14: '2 Chronicles',
		15: 'Ezra', 16: 'Nehemiah', 17: 'Esther', 18: 'Job', 19: 'Psalms',
		20: 'Proverbs', 21: 'Ecclesiastes', 22: 'Song of Solomon', 23: 'Isaiah',
		24: 'Jeremiah', 25: 'Lamentations', 26: 'Ezekiel', 27: 'Daniel',
		28: 'Hosea', 29: 'Joel', 30: 'Amos', 31: 'Obadiah', 32: 'Jonah',
		33: 'Micah', 34: 'Nahum', 35: 'Habakkuk', 36: 'Zephaniah',
		37: 'Haggai', 38: 'Zechariah', 39: 'Malachi', 40: 'Matthew',
		41: 'Mark', 42: 'Luke', 43: 'John', 44: 'Acts', 45: 'Romans',
		46: '1 Corinthians', 47: '2 Corinthians', 48: 'Galatians',
		49: 'Ephesians', 50: 'Philippians', 51: 'Colossians',
		52: '1 Thessalonians', 53: '2 Thessalonians', 54: '1 Timothy',
		55: '2 Timothy', 56: 'Titus', 57: 'Philemon', 58: 'Hebrews',
		59: 'James', 60: '1 Peter', 61: '2 Peter', 62: '1 John',
		63: '2 John', 64: '3 John', 65: 'Jude', 66: 'Revelation'
	};

	// Create Bible-wide histogram
	const bibleCanvas = document.getElementById('bible-histogram') as HTMLCanvasElement;
	if (bibleCanvas) {
		// Extract book data from data attributes or parse from page
		const allRefs = Array.from(document.querySelectorAll('[data-all-refs]'))
			.map(el => el.getAttribute('data-all-refs'))
			.filter(Boolean);

		// If no data attributes, parse from the references grid and count manually
		// Group by book code
		const bookCounts: Record<number, number> = {};

		// Parse all references to extract book codes
		const chapterElements = document.querySelectorAll('.chapter-references');
		chapterElements.forEach((el) => {
			const chapterTitle = el.querySelector('.chapter-title a')?.textContent;
			if (chapterTitle) {
				const verseCount = el.querySelectorAll('.verse-badge').length;
				bookCounts[10] = (bookCounts[10] || 0) + verseCount;
			}
		});

		// Get book data from meta tag (we'll add this)
		const bookDataEl = document.querySelector('meta[name="book-references"]');
		if (bookDataEl) {
			const bookData = JSON.parse(bookDataEl.getAttribute('content') || '{}');
			Object.assign(bookCounts, bookData);
		}

		const bookCodes = Object.keys(bookCounts).map(Number).sort((a, b) => a - b);
		const counts = bookCodes.map(code => bookCounts[code]);
		const labels = bookCodes.map(code => bookNames[code] || `Book ${code}`);

		new Chart(bibleCanvas, {
			type: 'bar',
			data: {
				labels: labels,
				datasets: [{
					label: 'Verse References',
					data: counts,
					backgroundColor: 'rgba(34, 139, 34, 0.6)',
					borderColor: 'rgba(34, 139, 34, 1)',
					borderWidth: 1,
					hoverBackgroundColor: 'rgba(34, 139, 34, 0.85)',
					hoverBorderColor: 'rgba(20, 100, 20, 1)',
					hoverBorderWidth: 2
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: true,
				aspectRatio: 2.5,
				plugins: {
					legend: { display: false },
					tooltip: {
						backgroundColor: 'rgba(0, 0, 0, 0.8)',
						padding: 12,
						cornerRadius: 6,
						titleFont: { size: 14, weight: 'bold' },
						bodyFont: { size: 13 },
						callbacks: {
							title: (context) => labels[context[0].dataIndex],
							label: (context) => {
								const count = context.parsed.y;
								return `${count} verse${count !== 1 ? 's' : ''}`;
							}
						}
					}
				},
				scales: {
					y: {
						beginAtZero: true,
						ticks: { stepSize: 1, font: { size: 11 } },
						grid: { color: 'rgba(0, 0, 0, 0.05)' },
						title: {
							display: true,
							text: 'Number of Verses',
							font: { size: 12, weight: 'bold' }
						}
					},
					x: {
						ticks: {
							font: { size: 10 },
							maxRotation: 45,
							minRotation: 45,
							autoSkip: false
						},
						grid: { display: false },
						title: {
							display: true,
							text: 'Bible Books',
							font: { size: 12, weight: 'bold' }
						}
					}
				}
			}
		});
	}

	// Create 2 Samuel histogram
	const samuelCanvas = document.getElementById('samuel-histogram') as HTMLCanvasElement;
	if (samuelCanvas) {
		const chapterElements = document.querySelectorAll('.chapter-references');
		const chapters: number[] = [];
		const verseCounts: number[] = [];

		chapterElements.forEach((el) => {
			const chapterTitle = el.querySelector('.chapter-title a')?.textContent;
			if (chapterTitle) {
				const chapterNum = parseInt(chapterTitle.replace('Chapter ', ''));
				const verseCount = el.querySelectorAll('.verse-badge').length;
				chapters.push(chapterNum);
				verseCounts.push(verseCount);
			}
		});

		new Chart(samuelCanvas, {
			type: 'bar',
			data: {
				labels: chapters.map(ch => `Ch ${ch}`),
				datasets: [{
					label: 'Verse References',
					data: verseCounts,
					backgroundColor: 'rgba(139, 69, 19, 0.6)',
					borderColor: 'rgba(139, 69, 19, 1)',
					borderWidth: 1,
					hoverBackgroundColor: 'rgba(139, 69, 19, 0.85)',
					hoverBorderColor: 'rgba(101, 50, 14, 1)',
					hoverBorderWidth: 2
				}]
			},
			options: {
				responsive: true,
				maintainAspectRatio: true,
				aspectRatio: 2.5,
				onClick: (event, activeElements) => {
					if (activeElements.length > 0) {
						const index = activeElements[0].index;
						const chapter = chapters[index];
						const chapterSection = Array.from(chapterElements).find((el) => {
							const title = el.querySelector('.chapter-title a')?.textContent;
							return title?.includes(`Chapter ${chapter}`);
						});
						if (chapterSection) {
							chapterSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
							chapterSection.classList.add('highlight-flash');
							setTimeout(() => {
								chapterSection.classList.remove('highlight-flash');
							}, 1500);
						}
					}
				},
				plugins: {
					legend: { display: false },
					tooltip: {
						backgroundColor: 'rgba(0, 0, 0, 0.8)',
						padding: 12,
						cornerRadius: 6,
						titleFont: { size: 14, weight: 'bold' },
						bodyFont: { size: 13 },
						callbacks: {
							title: (context) => `Chapter ${chapters[context[0].dataIndex]}`,
							label: (context) => {
								const count = context.parsed.y;
								return `${count} verse${count !== 1 ? 's' : ''}`;
							}
						}
					}
				},
				scales: {
					y: {
						beginAtZero: true,
						ticks: { stepSize: 1, font: { size: 11 } },
						grid: { color: 'rgba(0, 0, 0, 0.05)' },
						title: {
							display: true,
							text: 'Number of Verses',
							font: { size: 12, weight: 'bold' }
						}
					},
					x: {
						ticks: { font: { size: 11 } },
						grid: { display: false },
						title: {
							display: true,
							text: '2 Samuel Chapters',
							font: { size: 12, weight: 'bold' }
						}
					}
				}
			}
		});
	}
</script>

<style>
	.character-detail {
		max-width: 800px;
	}

	.character-header {
		margin-bottom: 3rem;
	}

	/* Metadata badges */
	.metadata-badges {
		display: flex;
		flex-wrap: wrap;
		gap: 1rem;
		margin-bottom: 1.5rem;
	}

	.metadata-badge {
		display: inline-flex;
		align-items: center;
		gap: 0.5rem;
		padding: 0.5rem 0.75rem;
		background: #f5f5f5;
		border-radius: 6px;
		font-size: 0.9rem;
	}

	.metadata-label {
		color: var(--color-text-light);
		font-weight: 500;
		font-size: 0.8rem;
		text-transform: uppercase;
		letter-spacing: 0.05em;
	}

	.metadata-value {
		color: var(--color-text);
		font-weight: 600;
		text-transform: capitalize;
	}

	/* Role badges */
	.roles {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
		margin-bottom: 1.5rem;
	}

	.role-badge {
		display: inline-block;
		padding: 0.25rem 0.75rem;
		background: var(--color-accent);
		color: white;
		border-radius: 20px;
		font-size: 0.85rem;
		font-weight: 500;
	}

	.description {
		font-size: 1.1rem;
		line-height: 1.7;
		color: var(--color-text);
	}

	.description :global(.character-link) {
		color: var(--color-accent);
		text-decoration: none;
		border-bottom: 1px solid transparent;
		transition: border-color 0.2s ease;
	}

	.description :global(.character-link:hover) {
		border-bottom-color: var(--color-accent);
	}

	/* Family Section */
	.family-section {
		margin-bottom: 3rem;
		padding: 2rem;
		background: #f9f9f9;
		border-radius: 8px;
	}

	.family-section h2 {
		font-family: var(--font-display);
		font-size: 1.8rem;
		margin: 0 0 1.5rem 0;
	}

	.family-tree {
		display: flex;
		flex-direction: column;
		gap: 2rem;
	}

	.family-group {
		display: flex;
		flex-direction: column;
		gap: 1rem;
	}

	.family-label {
		font-family: var(--font-display);
		font-size: 1.2rem;
		margin: 0;
		color: var(--color-text-light);
	}

	.family-members {
		display: flex;
		flex-wrap: wrap;
		gap: 1rem;
	}

	.family-member {
		display: flex;
		flex-direction: column;
		align-items: center;
		gap: 0.5rem;
		padding: 1rem;
		background: white;
		border: 2px solid #e5e5e5;
		border-radius: 8px;
		text-decoration: none;
		color: var(--color-text);
		transition: all 0.2s ease;
		min-width: 120px;
	}

	.family-member:hover {
		border-color: var(--color-accent);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
		transform: translateY(-2px);
	}

	.relation-icon {
		font-size: 1.5rem;
	}

	.member-name {
		font-weight: 600;
		text-align: center;
		font-family: var(--font-display);
	}

	.member-role {
		font-size: 0.85rem;
		color: var(--color-text-light);
		text-align: center;
	}

	/* References Section */
	.references-section {
		margin-bottom: 3rem;
	}

	.references-section h2 {
		font-family: var(--font-display);
		font-size: 1.8rem;
		margin: 0 0 1rem 0;
	}

	.references-intro {
		color: var(--color-text-light);
		margin-bottom: 1.5rem;
	}

	/* Histogram */
	.histogram-container {
		margin: 2rem 0 3rem 0;
		padding: 1.5rem;
		background: linear-gradient(135deg, #f9f9f9 0%, #ffffff 100%);
		border-radius: 12px;
		border: 1px solid #e5e5e5;
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
	}

	.histogram-title {
		font-family: var(--font-display);
		font-size: 1.2rem;
		margin: 0 0 1rem 0;
		color: var(--color-text);
		text-align: center;
	}

	.histogram-wrapper {
		position: relative;
		max-width: 100%;
		margin: 0 auto;
		cursor: pointer;
	}

	.histogram-wrapper canvas {
		max-height: 300px;
	}

	.references-grid {
		display: grid;
		gap: 1.5rem;
	}

	.chapter-references {
		padding: 1.5rem;
		background: #f9f9f9;
		border-radius: 8px;
		border-left: 4px solid var(--color-accent);
		transition: all 0.3s ease;
	}

	.chapter-references.highlight-flash {
		animation: highlight 1.5s ease-in-out;
	}

	@keyframes highlight {
		0% {
			background: #f9f9f9;
			transform: scale(1);
		}
		25% {
			background: rgba(139, 69, 19, 0.15);
			transform: scale(1.02);
		}
		75% {
			background: rgba(139, 69, 19, 0.08);
			transform: scale(1.01);
		}
		100% {
			background: #f9f9f9;
			transform: scale(1);
		}
	}

	.chapter-title {
		font-family: var(--font-display);
		font-size: 1.2rem;
		margin: 0 0 1rem 0;
	}

	.chapter-title a {
		color: var(--color-text);
		text-decoration: none;
		transition: color 0.2s ease;
	}

	.chapter-title a:hover {
		color: var(--color-accent);
	}

	.verses {
		display: flex;
		flex-wrap: wrap;
		gap: 0.5rem;
	}

	.verse-badge {
		display: inline-block;
		padding: 0.25rem 0.5rem;
		background: white;
		border: 1px solid #e5e5e5;
		border-radius: 4px;
		font-size: 0.9rem;
		font-weight: 500;
		color: var(--color-text);
	}

	.data-attribution {
		margin-top: 3rem;
		padding-top: 2rem;
		border-top: 1px solid #e5e5e5;
		text-align: center;
	}

	.data-attribution p {
		color: var(--color-text-light);
		font-size: 0.85rem;
		margin: 0;
	}

	.data-attribution a {
		color: var(--color-accent);
		text-decoration: none;
	}

	.data-attribution a:hover {
		text-decoration: underline;
	}

	@media (max-width: 768px) {
		.family-members {
			flex-direction: column;
		}

		.family-member {
			width: 100%;
		}
	}
</style>
